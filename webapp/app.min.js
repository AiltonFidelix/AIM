var seconds = null; var otaTimerVar = null; $(document).ready(function(){ getUpdateStatus(); }); function getFileInfo() { var x = document.getElementById("selected_file"); var file = x.files[0]; document.getElementById("file_info").innerHTML = "<h4>File: " + file.name + "<br>" + "Size: " + file.size + " bytes</h4>"; } function updateFirmware() { var formData = new FormData(); var fileSelect = document.getElementById("selected_file"); if (fileSelect.files && fileSelect.files.length == 1) { var file = fileSelect.files[0]; formData.set("file", file, file.name); document.getElementById("ota_update_status").innerHTML = "Uploading " + file.name + ", Firmware Update in Progress..."; var request = new XMLHttpRequest(); request.upload.addEventListener("progress", updateProgress); request.open('POST', "/OTAupdate"); request.responseType = "blob"; request.send(formData); } else { window.alert('Select A File First') } } function updateProgress(oEvent) { if (oEvent.lengthComputable) { getUpdateStatus(); } else { window.alert('total size is unknown') } } function getUpdateStatus() { var xhr = new XMLHttpRequest(); var requestURL = "/OTAstatus"; xhr.open('POST', requestURL, false); xhr.send('ota_update_status'); if (xhr.readyState == 4 && xhr.status == 200) { var response = JSON.parse(xhr.responseText); document.getElementById("latest_firmware").innerHTML = response.compile_date + " - " + response.compile_time; if (response.ota_update_status == 1) { seconds = 10; otaRebootTimer(); } else if (response.ota_update_status == -1) { document.getElementById("ota_update_status").innerHTML = "!!! Upload Error !!!"; } } } function otaRebootTimer() { document.getElementById("ota_update_status").innerHTML = "OTA Firmware Update Complete. This page will close shortly, Rebooting in: " + seconds; if (--seconds == 0) { clearTimeout(otaTimerVar); window.location.reload(); } else { otaTimerVar = setTimeout(otaRebootTimer, 1000); } }